function sendRequest(e,o=null,t=null){chrome.storage.local.get(null,function(n){if(null==n.instance||n.instance.length<4)return!1;let r={client:n.uuid,token:n.token},s="Bearer "+btoa(encodeURIComponent(JSON.stringify(r))),a=n.instance,i=n.uuid;"bookmarkAdd"===e.name&&n.sync&&n.direct&&(i="bookmarkTab");const c={action:e.name,client:i,data:o};Object.keys(c).forEach(e=>null==c[e]&&delete c[e]),fetch(a+"?api=v1",{method:"POST",cache:"no-cache",headers:{"Content-type":"application/json;charset=UTF-8",Authorization:s},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(c)}).then(e=>{e.status;let o=e.headers.get("X-Request-Info");return null!=o&&(0==o?(chrome.storage.local.remove("token"),changeIcon("error"),chrome.storage.local.set({popup:{message:"Token removed",mode:"error"}})):chrome.storage.local.set({token:o})),e.json()}).then(o=>{e(o,t)}).catch(e=>{loglines=logit("Error: "+e)})})}function clientSendOptions(e){200==e.code?(loglines=logit("Info: "+e.message),chrome.action.setBadgeText({text:""}),chrome.action.setBadgeBackgroundColor({color:"chartreuse"}),chrome.action.setTitle({title:chrome.i18n.getMessage("extensionName")}),changeIcon("info"),chrome.storage.local.set({popup:{message:e.message,mode:"success"}})):(changeIcon("warn"),chrome.storage.local.set({popup:{message:e.message,mode:"warn"}}),loglines=logit("Error: "+e.message))}function clientGetOptions(e){chrome.runtime.sendMessage({task:"clientOptions",cOptions:e.cOptions})}function clientRemove(e){}function clientList(e){chrome.storage.local.remove("clist"),chrome.storage.local.set({clist:e.clients}),chrome.permissions.getAll(function(o){if(o.permissions.includes("contextMenus")&&Array.isArray(e.clients)){e.clients.forEach(function(e){var o=e.name?e.name:e.id;chrome.contextMenus.create({title:o,type:"normal",parentId:"ssendpage",contexts:["page"],id:"page_"+e.id}),chrome.contextMenus.create({title:o,type:"normal",parentId:"ssendlink",contexts:["link"],id:"link_"+e.id});try{chrome.contextMenus.create({title:o,type:"normal",parentId:"ssendtab",contexts:["tab"],id:"tab_"+e.id})}catch{}});let o=e.clients.length-1;loglines=logit("Info: List of "+o+" clients received successful.")}}),loglines=logit("Info: Get notifications for current client."),sendRequest(pushGet)}function pushURL(e){e.error&&(loglines=logit("Error: "+e.error))}function pushGet(e){if(Array.isArray(e.notifications)){try{e.notifications.forEach(function(e){loglines=logit('Info: Received tab: <a href="'+e.url+'">'+e.url+"</a>"),openTab(e.url,e.nkey,e.title)})}catch(e){loglines=logit(e)}loglines=logit("Info: List of "+e.notifications.length+" notifications received successful.")}loglines=logit("Info: Start Sync"),sendRequest(clientInfo)}function clientInfo(e,o=null){null!==e&&(lastseen=e.lastseen,null!=o?chrome.runtime.sendMessage({task:clientInfo.name,type:"success",cname:e.cname,ctype:e.ctype,cinfo:e.cinfo}):chrome.storage.local.get(null,async function(e){let o=e.sync||!1;o&&doFullSync()}))}function bookmarkExport(e,o=null){let t=e.bookmarks;const n=[];0==abrowser&&(t=c2cm(t)),count=0,loglines=logit("Info: "+t.length+" Bookmarks received from server"),n.text=t.length+" Bookmarks received from server",n.type="success",n.task=bookmarkExport.name,importFull(t);let r=new Date(Date.now()),s={weekday:"short",hour:"2-digit",minute:"2-digit"};chrome.action.setTitle({title:chrome.i18n.getMessage("extensionName")+": "+r.toLocaleDateString(void 0,s)}),null!=o&&chrome.runtime.sendMessage({task:n.task,type:n.type,text:n.text}),loglines=logit("Info: Import finished")}function bookmarkImport(e){const o=[];200==e.code?(loglines=logit("Info: "+e.message),o.text="successExportBookmarks",o.type="success"):(loglines=logit("Error: "+e.message),o.text=chrome.i18n.getMessage("errorExportBookmarks"),o.type="error"),chrome.runtime.sendMessage({task:bookmarkImport.name,type:o.type,text:o.text})}function bookmarkAdd(e){let o="",t="";chrome.storage.local.get(null,async function(n){n.direct&&(200===e.code?(o="Bookmark added",changeIcon("info"),mode="0",t="Info"):(o=e.message,changeIcon("warn"),chrome.storage.local.set({popup:{message:e.message,mode:"warn"}}),mode="1",t="Error"),200!==e.code&&notify(Math.random().toString(16).substring(2,10),o),loglines=logit(t+": "+o))});let n=Date.now();chrome.storage.local.set({last_s:n})}function pushHide(e){e.error&&(loglines=logit("Error: "+e.error))}function bookmarkEdit(e){200==e.code?loglines=logit("Info: Bookmark edited successfully at the server"):(message="Error: Bookmark not edited at the server, please check the server logfile.",loglines=logit(message),notify("error",message))}function bookmarkMove(e){loglines=200==e.code?logit("Info: Bookmark moved successfully at the server"):logit("Error: Bookmark not moved on server. "+e.message)}function bookmarkDel(e){switch(e.code){case 200:loglines=logit("Info: "+e.message);break;case 204:changeIcon("warn"),loglines=logit("Warn: "+ +e.message),chrome.storage.local.set({popup:{message:e.message,mode:"warn"}});default:changeIcon("error"),loglines=logit("Error: "+ +e.message),chrome.storage.local.set({popup:{message:e.message,mode:"error"}})}let o=Date.now();chrome.storage.local.set({last_s:o})}function clientRename(e){const o=[];e.message?(loglines=logit("Error: "+e.message),o.type="error",o.text=e.message):(o.type="success",o.text="Client renamed",changeIcon("info")),chrome.runtime.sendMessage({task:clientRename.name,type:o.type,text:""+o.text})}function tabsSend(e){let o=parseInt(e.tabs);if(o<1){let e="Tabs could not be saved remotely, please check server log";loglines=logit(e),notify("error",e)}}function tabsGet(e){tabCount=e.tabs.length;for(let o=0;o<tabCount;o++)chrome.tabs.query({url:e.tabs[o].bmURL},function(t){0===t.length&&chrome.tabs.create({url:e.tabs[o].bmURL,active:!1})})}function getNewTabs(){sendRequest(tabsGet),chrome.tabs.onCreated.addListener(tabCreated),chrome.tabs.onUpdated.addListener(tabUpdated),chrome.tabs.onRemoved.addListener(tabCreated)}function tabCreated(e){setTimeout(()=>{chrome.tabs.query({},saveTabs)},3e3)}function tabUpdated(e,o){"complete"===o.status&&tabCreated(e)}function saveTabs(e){var o=[];e.forEach(function(e){void 0!==e.url&&!1===e.pinned&&!1===e.incognito&&e.url.startsWith("http")&&o.push({windowId:e.windowId,url:e.url,title:e.title})}),sendRequest(tabsSend,o)}function ccMenus(){chrome.permissions.getAll(function(e){e.permissions.includes("contextMenus")&&(chrome.contextMenus.removeAll(),chrome.storage.local.get(null,function(e){e.direct&&chrome.commands.getAll(e=>{for(let{name:t,shortcut:n}of e)var o="bookmark-tab"===t?n:"undef";chrome.contextMenus.create({title:chrome.i18n.getMessage("bookmarkTab")+` (${o})`,type:"normal",contexts:["page"],id:"smark"})});try{chrome.contextMenus.create({title:chrome.i18n.getMessage("sendPage"),type:"normal",contexts:["page"],id:"ssendpage"}),chrome.contextMenus.create({title:chrome.i18n.getMessage("sendLink"),type:"normal",contexts:["link"],id:"ssendlink"});try{chrome.contextMenus.create({title:chrome.i18n.getMessage("sendTab"),type:"normal",contexts:["tab"],id:"ssendtab"})}catch{}}catch(e){loglines=logit(e)}})),chrome.storage.local.get(null,function(e){!0===e.tabs&&getNewTabs()})})}function bookmarkTab(){chrome.tabs.query({active:!0,currentWindow:!0},function(e){let o=JSON.stringify({id:Math.random().toString(24).substring(2,12),url:e[0].url,title:e[0].title,type:"bookmark",folder:!0===abrowser?"unfiled_____":2,nfolder:"More Bookmarks",added:(new Date).valueOf()});sendRequest(bookmarkAdd,o)})}function sendTab(e){chrome.tabs.query({active:!0,currentWindow:!0},function(o){chrome.storage.local.get(null,function(t){const n={url:e.target.url?e.target.url:o[0].url,target:e.target.id};loglines=logit("Info: "+chrome.i18n.getMessage("sendLinkYes")+", Client: "+t.uuid),sendRequest(pushURL,n)})})}function logit(e){var o=new Date,t=loglines+o.toLocaleString()+" - "+e+"\n";return e.toString().toLowerCase().indexOf("error")>=0&&e.toString().toLowerCase().indexOf("TypeError")<=0&&(changeIcon("error"),chrome.storage.local.set({popup:{message:e,mode:"error"}})),t}function get_oMarks(){chrome.permissions.getAll(function(e){e.permissions.includes("bookmarks")&&chrome.bookmarks.getTree(function(e){oMarks=e})})}function removeAllMarks(){loglines=logit("Info: Try to remove all local bookmarks");try{chrome.bookmarks.onRemoved.removeListener(onRemovedCheck),chrome.bookmarks.getTree(function(e){e[0].children.forEach(function(e){e.children.forEach(function(e){chrome.bookmarks.onRemoved.removeListener(onRemovedCheck),chrome.bookmarks.removeTree(e.id)})})}),chrome.bookmarks.onRemoved.addListener(onRemovedCheck)}catch(e){loglines=logit(e)}finally{chrome.storage.local.set({last_s:1})}}function changeIcon(e){switch(e){case"error":chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"red"});break;case"warn":chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"gold"}),setTimeout(function(){chrome.action.setBadgeText({text:""})},5e3);break;case"info":chrome.action.setBadgeText({text:"i"}),chrome.action.setBadgeBackgroundColor({color:"chartreuse"}),chrome.action.setTitle({title:chrome.i18n.getMessage("extensionName")}),setTimeout(function(){chrome.action.setBadgeText({text:""})},5e3);break;default:statement(s)}}async function init(){loglines=logit("Info: AddOn version: "+chrome.runtime.getManifest().version),loglines=logit("Info: "+navigator.userAgent),chrome.runtime.getPlatformInfo(function(e){loglines=logit("Info: Current architecture: "+e.arch+" | Current OS: "+e.os)}),await get_oMarks(),chrome.storage.local.set({last_message:""}),chrome.storage.local.get(null,async function(e){if(null==e.instance)return changeIcon("error"),chrome.storage.local.set({popup:{message:"Instance undefined",mode:"error"}}),loglines=logit("Error: Instance undefined"),!1;void 0===e.token?(changeIcon("error"),chrome.storage.local.set({popup:{message:"Login token missing",mode:"error"}}),loglines=logit("Error: Login token missing")):chrome.action.setBadgeText({text:""}),e.instance&&(await ccMenus(),loglines=logit("Info: Get list of clients."),sendRequest(clientList),loglines=logit("Info: Init finished"))})}function onTabActivated(e){pTabs.forEach(async function(o,t){o.tID==e.tabId&&(sendRequest(pushHide,o.nID),pTabs.splice(t,1))})}function pTabsLoad(e,o){var t={tID:e,nID:Number(o)};chrome.storage.local.get(["pTabs"],function(e){pTabs.length=0,void 0!==e.pTabs&&e.pTabs.forEach(function(e){pTabs.push(e)}),pTabs.push(t),pTabsSave(pTabs)})}function pTabsSave(e){chrome.storage.local.set({pTabs:e})}function openTab(e,o,t){chrome.tabs.query({url:e},function(n){n.length<1?chrome.tabs.create({url:e,active:!1},function(e){pTabsLoad(e.id,o)}):pTabsLoad(n[0].id,o);let r=JSON.stringify({id:o,url:e});notify(r,e,t)})}function notificationSettings(e){let o=0===e.indexOf('{"id":')?"url":e.substring(0,e.indexOf("_")),t=["console","error","setting"];if(t.includes(o))debug=!0,chrome.runtime.openOptionsPage();else{let o;try{o=JSON.parse(e.substring(0,e.indexOf("_")))}catch(e){}if(void 0!==o)try{chrome.tabs.query({url:o.url},function(e){e.length>0&&chrome.tabs.highlight({tabs:e[0].index})})}catch(e){loglines=logit(e)}}}function onInstalled(e){"install"==e.reason&&(chrome.runtime.openOptionsPage(),checkCommandShortcuts()),"update"==e.reason&&migrateOptions()}function migrateOptions(){chrome.storage.local.get(null,function(e){null!=e.wdurl&&chrome.storage.local.set({sync:e.actions.startup,direct:e.actions.crsrv,uuid:e.s_uuid,tabs:e.s_tabs,instance:e.wdurl}),null!=e.sync&&(chrome.storage.local.set({direct:e.sync.manual}),chrome.storage.local.set({sync:e.sync.auto}))})}function checkCommandShortcuts(){chrome.commands.getAll(e=>{let o=[];for(let{name:t,shortcut:n}of e)""===n&&o.push(t);o.length>0&&notify("error","Default Shortcuts for Extension (Ctrl+Q) could not be set. Please check your settings, if they are blocked by another extension. You can set your own Shortcut in Browser settings.")})}function notify(e,o,t=chrome.i18n.getMessage("extensionName")){e=e+"_"+Date.now().toString();try{chrome.notifications.create(e,{type:"basic",title:t,iconUrl:"/icons/bookmark.png",message:o})}catch(e){loglines=logit(e)}}function onCreatedCheck(e,o){get_oMarks(),chrome.storage.local.get(null,function(e){var t=e.sync||!1;t&&sendMark(o)})}function onMovedCheck(e,o){get_oMarks(),chrome.storage.local.get(null,async function(t){var n=t.sync||!1;n&&chrome.bookmarks.get(o.parentId,function(t){chrome.bookmarks.get(e,function(n){let r={id:e,index:o.index,folderIndex:t[0].index,folder:o.parentId,nfolder:t[0].title,url:n[0].url,title:n[0].title};loglines=logit("Info: Sending move request to server. Bookmark ID: "+e),sendRequest(bookmarkMove,r)})})})}function onChangedCheck(e,o){get_oMarks(),chrome.storage.local.get(null,function(t){var n=t.sync||!1;n&&chrome.bookmarks.get(e,function(e){let t={url:e[0].url,title:e[0].title,parentId:e[0].parentId,index:e[0].index};loglines=logit("Info: Sending edit request to server. URL: "+o.url),sendRequest(bookmarkEdit,t)})})}function onRemovedCheck(e,o){chrome.storage.local.get(null,async function(e){var t=e.sync||!1;t&&(await removeMark(o),await get_oMarks())})}function exportPHPMarks(e=[]){loglines=logit("Info: Send new local bookmarks to server");let o="",t=0;chrome.bookmarks.getTree(function(n){0===e.length?(o=n,t=0):(o=e,t=1),sendRequest(bookmarkImport,o)});let n=Date.now();chrome.storage.local.set({last_s:n})}function removeMark(e){chrome.bookmarks.get(e.parentId,async function(o){let t={url:e.node.url,folder:e.parentId,nfolder:o[0].title,index:e.index,type:e.node.type,id:e.node.id,title:e.node.title};loglines=logit("Info: Sending remove request to server: <a href='"+e.node.url+"'>"+e.node.url+"</a>"),sendRequest(bookmarkDel,t)})}function sendMark(e){"type"in e||"url"in e?!("type"in e)&&"url"in e&&(e.type="bookmark"):e.type="folder",chrome.bookmarks.get(e.parentId,async function(o){let t={id:e.id,url:e.url,title:e.title,type:e.type,folder:e.parentId,nfolder:o[0].title,added:e.dateAdded};loglines=logit("Info: Sending add request to server: <a href='"+e.url+"'>"+e.url+"</a>"),sendRequest(bookmarkAdd,t)})}async function doFullSync(){loglines=logit("Info: Sync started.");try{chrome.storage.local.get(null,async function(e){loglines=logit("Info: Sending Sync request to server"),sendRequest(bookmarkExport,"json")})}catch(e){loglines=logit(e)}finally{chrome.storage.local.set({last_s:1})}}async function importFull(e){function o(e){e.forEach(function(e){s.push(e),e.children&&o(e.children)})}async function t(o,t){let n=0,r=(await searchBookmarkAsync({title:o.bmTitle}))[0];if(void 0===r)n=1;else{let t=e.filter(e=>e.bmID===o.bmParentID)[0].bmTitle,s=(await getBookmarkAsync(r.parentId))[0].title;n=t!==s?2:3}return n}async function n(o){let t="",n="";if(o.bmParentID.endsWith("_____")||1===o.bmParentID.length)n=o.bmParentID;else{let r=o.bmParentID;t=null!=e.filter(e=>e.bmID==r)[0]?e.filter(e=>e.bmID==r)[0].bmTitle:"";let s=await searchBookmarkAsync({title:t});if(!(s.length>0))return!1;n=s[0].id}let r={};abrowser?(r.index=parseInt(o.bmIndex),r.parentId=n,r.title=o.bmTitle,r.url=o.bmURL,r.type=o.bmType):(r.parentId=n,r.title=o.bmTitle,r.url=o.bmURL);let s=await createBookmarkAsync(r),a=s;if(a&&void 0===typeof a.url){let t=o.bmID,n=a.id;e.forEach(async function(o,r){e[r].bmParentID===t&&(e[r].bmParentID=n),e[r].bmID===t&&(e[r].bmID=n)})}}async function r(o){let t=(await searchBookmarkAsync({title:o.bmTitle}))[0],n="",r="";if(o.bmParentID.endsWith("_____")||1===o.bmParentID.length)r=o.bmParentID;else{let t=o.bmParentID;n=e.filter(e=>e.bmID==t)[0].bmTitle;let s=await searchBookmarkAsync({title:n});if(0==s.length)return!1;r=(await searchBookmarkAsync({title:n}))[0].id}let s=new Object;s.parentId=r,"bmIndex"in o&&(s.index=parseInt(o.bmIndex));await moveBookmarkAsync(t.id,s)}loglines=logit("Info: Starting import");const s=[],a=new Array,i=new Array;o(oMarks),s.forEach(function(o){const t=e.some(e=>e.bmTitle===o.title);t||a.push(o)}),chrome.bookmarks.onCreated.removeListener(onCreatedCheck),chrome.bookmarks.onMoved.removeListener(onMovedCheck),chrome.bookmarks.onRemoved.removeListener(onRemovedCheck);for(let o=0;o<e.length;o++){let s=0;switch(remoteMark=e[o],s=!0===abrowser&&!remoteMark.bmID.endsWith("_____")||!1===abrowser&&remoteMark.bmID.length>1?await t(remoteMark,o):0,s){case 0:loglines=logit('Debug: Ignore bookmark "'+remoteMark.bmID+'"');break;case 1:loglines=logit('Debug: Create bookmark "'+remoteMark.bmID+'"'),await n(remoteMark);break;case 2:loglines=logit('Debug: Move bookmark "'+remoteMark.bmID+'"'),await r(remoteMark);break;case 3:loglines=logit('Debug: Existing Bookmark "'+remoteMark.bmID+'"'),await r(remoteMark);break;default:loglines=logit('Debug: Unknown action for bookmark "'+remoteMark.bmID+'"')}}let c=0==lastseen?Date.now():lastseen;a.forEach(e=>{e.id.endsWith("_____")||e.id.length<2||(e.dateAdded>=c?i.push(e):(chrome.bookmarks.onRemoved.removeListener(onRemovedCheck),chrome.bookmarks.remove(e.id,function(e){})))}),chrome.bookmarks.onCreated.addListener(onCreatedCheck),chrome.bookmarks.onMoved.addListener(onMovedCheck),chrome.bookmarks.onRemoved.addListener(onRemovedCheck),i.length>0&&exportPHPMarks(i)}function c2cm(e){return e.forEach(e=>{"root________"==e.bmID&&(e.bmID="0"),"root________"==e.bmParentID&&(e.bmParentID="0"),"toolbar_____"==e.bmID&&(e.bmID="1"),"toolbar_____"==e.bmParentID&&(e.bmParentID="1"),"unfiled_____"==e.bmID&&(e.bmID="2"),"unfiled_____"==e.bmParentID&&(e.bmParentID="2"),"mobile______"==e.bmID&&(e.bmID="3"),"mobile______"==e.bmParentID&&(e.bmParentID="3"),"menu________"==e.bmID&&(e.bmID="2"),"menu________"==e.bmParentID&&(e.bmParentID="2")}),e}function getBookmarkAsync(e){return new Promise(function(o,t){chrome.bookmarks.get(e,o)})}function searchBookmarkAsync(e){return new Promise(function(o,t){chrome.bookmarks.search(e,o)})}function createBookmarkAsync(e){return new Promise(function(o,t){chrome.bookmarks.create(e,o)})}function moveBookmarkAsync(e,o){return new Promise(function(t,n){chrome.bookmarks.move(e,o,t)})}function importMarks(e,o=0){let t=e[o].bmID,n=e[o].bmParentID,r=parseInt(e[o].bmIndex,10),s=e[o].bmTitle,a=e[o].bmType,i=e[o].bmURL;if(1==abrowser){var c=void 0!==n&&"__"==n.substr(n.length-2)?n:dictOldIDsToNewIDs[n];if("root________"==n)return importMarks(e,++o),!1}else{c=void 0!==n&&n.length<2?n:dictOldIDsToNewIDs[n];if("0"==n)return importMarks(e,++o),!1}chrome.bookmarks.onCreated.removeListener(onCreatedCheck),chrome.bookmarks.onMoved.removeListener(onMovedCheck),chrome.bookmarks.onRemoved.removeListener(onRemovedCheck),chrome.bookmarks.onChanged.removeListener(onChangedCheck),1==abrowser?chrome.bookmarks.create("folder"==a?{index:r,parentId:c,title:s,type:a}:{index:r,parentId:c,title:s,type:a,url:i},function(n){let r="__"==t.substr(t.length-2)?t:n.id;dictOldIDsToNewIDs[t]=r,++count,void 0===e[o+1]?(message=count+chrome.i18n.getMessage("successImportBookmarks"),notify("info",message),loglines=logit("Info: "+message+" Re-adding the listeners now"),chrome.bookmarks.onCreated.addListener(onCreatedCheck),chrome.bookmarks.onMoved.addListener(onMovedCheck),chrome.bookmarks.onRemoved.addListener(onRemovedCheck),chrome.bookmarks.onChanged.addListener(onChangedCheck)):importMarks(e,++o)}):t.length>1&&chrome.bookmarks.create("folder"==a?{index:r,parentId:c,title:s}:{parentId:c,title:s,url:i},function(n){let r=e.length,s=o+1;if(s<r){let o=t.length<2?t:n.id;dictOldIDsToNewIDs[t]=o,importMarks(e,s)}else message=e.length+chrome.i18n.getMessage("successImportBookmarks"),notify("info",message),loglines=logit("Info: "+message+" Re-adding the listeners now"),chrome.bookmarks.onCreated.addListener(onCreatedCheck),chrome.bookmarks.onMoved.addListener(onMovedCheck),chrome.bookmarks.onRemoved.addListener(onRemovedCheck),chrome.bookmarks.onChanged.addListener(onChangedCheck)})}function addAllMarks(e,o=1){chrome.bookmarks.onCreated.removeListener(onCreatedCheck);let t=e[o].id,n=e[o].parentId,r=e[o].index,s=e[o].title,a=e[o].type,i=e[o].url,c=e[o].dateAdded,l=void 0!==n&&"__"==n.substr(n.length-2)?n:dictOldIDsToNewIDs[n];if("root________"==n||c<last_s)return addAllMarks(e,++o),!1;chrome.bookmarks.create("separator"==a?{index:r,parentId:l,type:a}:"folder"==a?{index:r,parentId:l,title:s,type:a}:{index:r,parentId:l,title:s,type:a,url:i},function(n){let r="__"==t.substr(t.length-2)?t:n.id;if(dictOldIDsToNewIDs[t]=r,++count,void 0!==e[o+1])addAllMarks(e,++o);else{message=count+chrome.i18n.getMessage("successImportBookmarks"),notify("info",message),loglines=logit("Info: "+message),chrome.bookmarks.onCreated.addListener(onCreatedCheck),chrome.bookmarks.onRemoved.addListener(onRemovedCheck);let e=Date.now(),o=new Date(e),t={weekday:"short",hour:"2-digit",minute:"2-digit"};chrome.storage.local.set({last_s:e}),chrome.action.setTitle({title:chrome.i18n.getMessage("extensionName")+": "+o.toLocaleDateString(void 0,t)})}})}const abrowser="undefined"!=typeof browser;var dictOldIDsToNewIDs={"-1":"-1"},loglines="",debug=!1,oMarks=[],pTabs=[],lastseen=null;const pingInterval=setInterval(()=>{chrome.runtime.getPlatformInfo,self.serviceWorker.postMessage("keep")},2e4);chrome.runtime.onStartup.addListener(async()=>{init()}),abrowser&&init(),chrome.runtime.onMessage.addListener(function(e,o,t){if(o.id===chrome.runtime.id)switch(e.action){case"clientInfo":sendRequest(clientInfo,e.data,e.tab);break;case"clientRename":sendRequest(clientRename,e.data);break;case"clientSendOptions":sendRequest(clientSendOptions,e.data);break;case"clientGetOptions":sendRequest(clientGetOptions);break;case"clientRemove":sendRequest(clientRemove,e.data);break;case"removeAllMarks":removeAllMarks();break;case"bookmarkExport":sendRequest(bookmarkExport,e.data,e.tab);break;case"exportPHPMarks":exportPHPMarks();break;case"loglines":console.log(e.data);break;case"getLoglines":0==loglines.length&&(loglines=logit("Info: No Log entry available")),chrome.runtime.sendMessage({task:"rLoglines",text:loglines});break;case"emptyLoglines":loglines="",chrome.runtime.sendMessage({task:"rLoglines",text:loglines});break;case"changeIcon":changeIcon(e.data);break;case"bookmarkTab":bookmarkTab();break;default:return!1}}),chrome.permissions.getAll(function(e){chrome.storage.local.get(null,function(e){e.sync&&!e.direct&&(chrome.bookmarks.onCreated.addListener(onCreatedCheck),chrome.bookmarks.onMoved.addListener(onMovedCheck),chrome.bookmarks.onRemoved.addListener(onRemovedCheck),chrome.bookmarks.onChanged.addListener(onChangedCheck))}),e.permissions.includes("contextMenus")&&chrome.contextMenus.onClicked.addListener(function(e){if((e.menuItemId.includes("page_")||e.menuItemId.includes("tab_"))&&chrome.tabs.query({active:!0,currentWindow:!0},function(o){let t={target:{id:e.menuItemId.substring(5),url:o[0].url}};sendTab(t)}),e.menuItemId.includes("link_")){let o={target:{id:e.menuItemId.substring(5),url:e.linkUrl}};sendTab(o)}})}),chrome.runtime.onInstalled.addListener(onInstalled),chrome.notifications.onClicked.addListener(notificationSettings),chrome.tabs.onActivated.addListener(onTabActivated),chrome.commands.onCommand.addListener(e=>{bookmarkTab()});