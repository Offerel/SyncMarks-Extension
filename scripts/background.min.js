function sendRequest(e,t=null,o=null){chrome.storage.local.get(null,function(n){if(null==n.instance||n.instance.length<4)return!1;let r={client:n.uuid,token:n.token},a="Bearer "+btoa(encodeURIComponent(JSON.stringify(r))),s=n.instance,i=n.uuid;"bookmarkAdd"===e.name&&!1===n.sync&&(i="bookmarkTab");const c={action:e.name,client:i,data:t};Object.keys(c).forEach(e=>null==c[e]&&delete c[e]),fetch(s+"?api=v1",{method:"POST",cache:"no-cache",headers:{"Content-type":"application/json;charset=UTF-8",Authorization:a},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(c)}).then(e=>{let t=e.headers.get("X-Request-Info");return null!=t&&(0==t?(chrome.storage.local.remove("token"),changeIcon("error"),chrome.storage.local.set({popup:{message:"Token removed",mode:"error"}})):chrome.storage.local.set({token:t})),e.json()}).then(t=>{e(t,o)}).catch(t=>{loglines=logit("Error: "+e+": "+t)})})}function clientSendOptions(e){200==e.code?(loglines=logit("Info: "+e.message),chrome.action.setBadgeText({text:""}),chrome.action.setBadgeBackgroundColor({color:"chartreuse"}),chrome.action.setTitle({title:chrome.i18n.getMessage("extensionName")}),changeIcon("info"),chrome.storage.local.set({popup:{message:e.message,mode:"success"}})):(changeIcon("warn"),chrome.storage.local.set({popup:{message:e.message,mode:"warn"}}),loglines=logit("Error: "+e.message))}function clientGetOptions(e){chrome.runtime.sendMessage({task:"clientOptions",cOptions:e.cOptions})}function clientRemove(e){}function clientList(e){chrome.storage.local.remove("clist"),chrome.storage.local.set({clist:e.clients}),chrome.permissions.getAll(function(t){if(t.permissions.includes("contextMenus")&&Array.isArray(e.clients)){e.clients.forEach(function(e){var t=e.name?e.name:e.id;chrome.contextMenus.create({title:t,type:"normal",parentId:"ssendpage",contexts:["page"],id:"page_"+e.id}),chrome.contextMenus.create({title:t,type:"normal",parentId:"ssendlink",contexts:["link"],id:"link_"+e.id});try{chrome.contextMenus.create({title:t,type:"normal",parentId:"ssendtab",contexts:["tab"],id:"tab_"+e.id})}catch{}});let t=e.clients.length-1;loglines=logit("Info: List of "+t+" clients received successful.")}}),loglines=logit("Info: Get notifications for current client."),sendRequest(pushGet)}function pushURL(e){e.error&&(loglines=logit("Error: "+e.error))}function pushGet(e){if(Array.isArray(e.notifications)){try{e.notifications.forEach(function(e){loglines=logit('Info: Received tab: <a href="'+e.url+'">'+e.url+"</a>"),openTab(e.url,e.nkey,e.title)})}catch(e){loglines=logit("pushGet: "+e)}loglines=logit("Info: List of "+e.notifications.length+" notifications received successful.")}loglines=logit("Info: Start Sync"),sendRequest(clientInfo)}function clientInfo(e,t=null){null!==e&&(lastseen=e.lastseen,null!=t?chrome.runtime.sendMessage({task:clientInfo.name,type:"success",cname:e.cname,ctype:e.ctype,cinfo:e.cinfo}):chrome.storage.local.get(null,async function(e){let t=e.sync||!1;t&&doFullSync()}))}function bookmarkExport(e,t=null){let o=e.bookmarks;const n=[];!1===mozilla&&(o=c2cm(o)),count=0,loglines=logit("Info: "+o.length+" Bookmarks received from server"),n.text=o.length+" Bookmarks received from server",n.type="success",n.task=bookmarkExport.name,importFull(o);let r=new Date(Date.now()),a={weekday:"short",hour:"2-digit",minute:"2-digit"};chrome.action.setTitle({title:chrome.i18n.getMessage("extensionName")+": "+r.toLocaleDateString(void 0,a)}),null!=t&&chrome.runtime.sendMessage({task:n.task,type:n.type,text:n.text}),loglines=logit("Info: Import finished")}function bookmarkImport(e){const t=[];200==e.code?(loglines=logit("Info: "+e.message),t.text="successExportBookmarks",t.type="success"):(loglines=logit("Error: bookmarkImport: "+e.message),t.text=chrome.i18n.getMessage("errorExportBookmarks"),t.type="error"),chrome.runtime.sendMessage({task:bookmarkImport.name,type:t.type,text:t.text})}function bookmarkAdd(e){let t="",o="";chrome.storage.local.get(null,async function(n){!1===n.sync&&(200===e.code?(t="Bookmark added",changeIcon("info"),mode="0",o="Info"):(t=e.message,changeIcon("warn"),chrome.storage.local.set({popup:{message:"bookmarkAdd: "+e.message,mode:"warn"}}),mode="1",o="Error"),200!==e.code&&notify(Math.random().toString(16).substring(2,10),t),loglines=logit(o+": "+t))});let n=Date.now();chrome.storage.local.set({last_s:n})}function pushHide(e){e.error&&(loglines=logit("Error: pushHide: "+e.error))}function bookmarkEdit(e){200==e.code?loglines=logit("Info: Bookmark edited successfully at the server"):(message="Error: Bookmark not edited at the server, please check the server logfile.",loglines=logit(message),notify("error",message))}function bookmarkMove(e){loglines=200==e.code?logit("Info: Bookmark moved successfully at the server"):logit("Error: Bookmark not moved on server. "+e.message)}function bookmarkDel(e){switch(e.code){case 200:loglines=logit("Info: "+e.message);break;case 204:changeIcon("warn"),loglines=logit("Warn: "+ +e.message),chrome.storage.local.set({popup:{message:e.message,mode:"warn"}});default:changeIcon("error"),loglines=logit("Error: bookmarkDel: "+ +e.message),chrome.storage.local.set({popup:{message:"bookmarkDel: "+e.message,mode:"error"}})}let t=Date.now();chrome.storage.local.set({last_s:t})}function clientRename(e){const t=[];e.message?(loglines=logit("Error: "+e.message),t.type="error",t.text=e.message):(t.type="success",t.text="Client renamed",changeIcon("info")),chrome.runtime.sendMessage({task:clientRename.name,type:t.type,text:""+t.text})}function tabsSend(e){if(parseInt(e.tabs)<1){let e="Tabs could not be saved, please check server error log";loglines=logit(e),changeIcon("error")}}function tabsGet(e){for(let t=0;t<e.tabs.length;t++)chrome.tabs.query({url:e.tabs[t].bmURL},function(o){0===o.length&&chrome.tabs.create({url:e.tabs[t].bmURL,active:!1})})}function getNewTabs(){sendRequest(tabsGet),tabSync(!0)}function tabSync(e){!0===e?(chrome.tabs.onCreated.addListener(tabCreated),chrome.tabs.onUpdated.addListener(tabUpdated),chrome.tabs.onRemoved.addListener(tabCreated)):(chrome.tabs.onCreated.removeListener(tabCreated),chrome.tabs.onUpdated.removeListener(tabUpdated),chrome.tabs.onRemoved.removeListener(tabCreated))}function bookmarkSync(e){!0===e?(chrome.bookmarks.onCreated.addListener(onCreatedCheck),chrome.bookmarks.onMoved.addListener(onMovedCheck),chrome.bookmarks.onRemoved.addListener(onRemovedCheck),chrome.bookmarks.onChanged.addListener(onChangedCheck)):(chrome.bookmarks.onCreated.removeListener(onCreatedCheck),chrome.bookmarks.onMoved.removeListener(onMovedCheck),chrome.bookmarks.onRemoved.removeListener(onRemovedCheck),chrome.bookmarks.onChanged.removeListener(onChangedCheck))}function tabCreated(e){setTimeout(()=>{chrome.tabs.query({},saveTabs)},3e3)}function tabUpdated(e,t){"complete"===t.status&&tabCreated(e)}function saveTabs(e){var t=[];e.forEach(function(e){void 0!==e.url&&!1===e.pinned&&!1===e.incognito&&e.url.startsWith("http")&&t.push({windowId:e.windowId,url:e.url,title:e.title})}),sendRequest(tabsSend,t)}function ccMenus(){chrome.permissions.getAll(function(e){e.permissions.includes("contextMenus")&&(chrome.contextMenus.removeAll(),chrome.storage.local.get(null,function(e){!1===e.sync&&chrome.commands.getAll(e=>{for(let{name:o,shortcut:n}of e)var t="bookmark-tab"===o?n:"undef";chrome.contextMenus.create({title:chrome.i18n.getMessage("bookmarkTab")+` (${t})`,type:"normal",contexts:["page"],id:"smark"})});try{chrome.contextMenus.create({title:chrome.i18n.getMessage("sendPage"),type:"normal",contexts:["page"],id:"ssendpage"}),chrome.contextMenus.create({title:chrome.i18n.getMessage("sendLink"),type:"normal",contexts:["link"],id:"ssendlink"});try{chrome.contextMenus.create({title:chrome.i18n.getMessage("sendTab"),type:"normal",contexts:["tab"],id:"ssendtab"})}catch{}}catch(e){loglines=logit("ccMenus: "+e)}})),chrome.storage.local.get(null,function(e){!0===e.tabs&&getNewTabs()})})}function bookmarkTab(){chrome.tabs.query({active:!0,currentWindow:!0},function(e){let t=JSON.stringify({id:Math.random().toString(24).substring(2,12),url:e[0].url,title:e[0].title,type:"bookmark",folder:!0===mozilla?"unfiled_____":2,nfolder:"More Bookmarks",added:(new Date).valueOf()});sendRequest(bookmarkAdd,t)})}function sendTab(e){chrome.tabs.query({active:!0,currentWindow:!0},function(t){chrome.storage.local.get(null,function(o){const n={url:e.target.url?e.target.url:t[0].url,target:e.target.id};loglines=logit("Info: "+chrome.i18n.getMessage("sendLinkYes")+", Client: "+o.uuid),sendRequest(pushURL,n)})})}function logit(e){var t=new Date,o=loglines+t.toLocaleString()+" - "+e+"\n";return e.toString().toLowerCase().indexOf("error")>=0&&(changeIcon("error"),chrome.storage.local.set({popup:{message:e,mode:"error"}})),o}function get_oMarks(){chrome.permissions.getAll(function(e){e.permissions.includes("bookmarks")&&chrome.bookmarks.getTree(function(e){oMarks=e})})}function removeAllMarks(){loglines=logit("Info: Try to remove all local bookmarks");try{chrome.bookmarks.onRemoved.removeListener(onRemovedCheck),chrome.bookmarks.getTree(function(e){e[0].children.forEach(function(e){e.children.forEach(function(e){chrome.bookmarks.onRemoved.removeListener(onRemovedCheck),chrome.bookmarks.removeTree(e.id)})})}),chrome.bookmarks.onRemoved.addListener(onRemovedCheck)}catch(e){loglines=logit(e)}finally{chrome.storage.local.set({last_s:1})}}function changeIcon(e){switch(e){case"error":chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"red"});break;case"warn":chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"gold"}),setTimeout(function(){chrome.action.setBadgeText({text:""})},5e3);break;case"info":chrome.action.setBadgeText({text:"i"}),chrome.action.setBadgeBackgroundColor({color:"chartreuse"}),chrome.action.setTitle({title:chrome.i18n.getMessage("extensionName")}),setTimeout(function(){chrome.action.setBadgeText({text:""})},5e3);break;default:statement(s)}}async function init(){loglines=logit("Info: AddOn version: "+chrome.runtime.getManifest().version),loglines=logit("Info: "+navigator.userAgent),chrome.runtime.getPlatformInfo(function(e){loglines=logit("Info: Current architecture: "+e.arch+" | Current OS: "+e.os)}),await get_oMarks(),chrome.storage.local.set({last_message:""}),chrome.storage.local.get(null,async function(e){if(null==e.instance)return changeIcon("error"),chrome.storage.local.set({popup:{message:"Instance undefined",mode:"error"}}),loglines=logit("Error: Instance undefined"),!1;void 0===e.token?(changeIcon("error"),chrome.storage.local.set({popup:{message:"Login token missing",mode:"error"}}),loglines=logit("Error: Login token missing")):chrome.action.setBadgeText({text:""}),e.instance&&(await ccMenus(),loglines=logit("Info: Get list of clients."),sendRequest(clientList),loglines=logit("Info: Init finished"))})}function onTabActivated(e){pTabs.forEach(async function(t,o){t.tID==e.tabId&&(sendRequest(pushHide,t.nID),pTabs.splice(o,1))})}function pTabsLoad(e,t){var o={tID:e,nID:Number(t)};chrome.storage.local.get(["pTabs"],function(e){pTabs.length=0,void 0!==e.pTabs&&e.pTabs.forEach(function(e){pTabs.push(e)}),pTabs.push(o),pTabsSave(pTabs)})}function pTabsSave(e){chrome.storage.local.set({pTabs:e})}function openTab(e,t,o){chrome.tabs.query({url:e},function(n){n.length<1?chrome.tabs.create({url:e,active:!1},function(e){pTabsLoad(e.id,t)}):pTabsLoad(n[0].id,t);let r=JSON.stringify({id:t,url:e});notify(r,e,o)})}function notificationSettings(e){let t=0===e.indexOf('{"id":')?"url":e.substring(0,e.indexOf("_")),o=["console","error","setting"];if(o.includes(t))debug=!0,chrome.runtime.openOptionsPage();else{let t;try{t=JSON.parse(e.substring(0,e.indexOf("_")))}catch(e){}if(void 0!==t)try{chrome.tabs.query({url:t.url},function(e){e.length>0&&chrome.tabs.highlight({tabs:e[0].index})})}catch(e){loglines=logit(e)}}}function onInstalled(e){"install"==e.reason&&(chrome.runtime.openOptionsPage(),checkCommandShortcuts()),"update"==e.reason&&migrateOptions()}function migrateOptions(){chrome.storage.local.get(null,function(e){null!=e.wdurl&&chrome.storage.local.set({sync:e.actions.startup,uuid:e.s_uuid,tabs:e.s_tabs,instance:e.wdurl}),null!=e.sync&&chrome.storage.local.set({sync:e.sync.auto})})}function checkCommandShortcuts(){chrome.commands.getAll(e=>{let t=[];for(let{name:o,shortcut:n}of e)""===n&&t.push(o);t.length>0&&notify("error","Default Shortcuts for Extension (Ctrl+Q) could not be set. Please check your settings, if they are blocked by another extension. You can set your own Shortcut in Browser settings.")})}function notify(e,t,o=chrome.i18n.getMessage("extensionName")){e=e+"_"+Date.now().toString();try{chrome.notifications.create(e,{type:"basic",title:o,iconUrl:"/icons/bookmark.png",message:t})}catch(e){loglines=logit(e)}}function onCreatedCheck(e,t){get_oMarks(),chrome.storage.local.get(null,function(e){var o=e.sync||!1;o&&sendMark(t)})}function onMovedCheck(e,t){get_oMarks(),chrome.storage.local.get(null,async function(o){var n=o.sync||!1;n&&chrome.bookmarks.get(t.parentId,function(o){chrome.bookmarks.get(e,function(n){let r={id:e,index:t.index,folderIndex:o[0].index,folder:t.parentId,nfolder:o[0].title,url:n[0].url,title:n[0].title};loglines=logit("Info: Sending move request to server. Bookmark ID: "+e),sendRequest(bookmarkMove,r)})})})}function onChangedCheck(e,t){get_oMarks(),chrome.storage.local.get(null,function(o){var n=o.sync||!1;n&&chrome.bookmarks.get(e,function(e){let o={url:e[0].url,title:e[0].title,parentId:e[0].parentId,index:e[0].index};loglines=logit("Info: Sending edit request to server. URL: "+t.url),sendRequest(bookmarkEdit,o)})})}function onRemovedCheck(e,t){chrome.storage.local.get(null,async function(e){var o=e.sync||!1;o&&(await removeMark(t),await get_oMarks())})}function exportPHPMarks(e=[]){loglines=logit("Info: Send new local bookmarks to server");let t="",o=0;chrome.bookmarks.getTree(function(n){0===e.length?(t=n,o=0):(t=e,o=1),sendRequest(bookmarkImport,t)});let n=Date.now();chrome.storage.local.set({last_s:n})}function removeMark(e){chrome.bookmarks.get(e.parentId,async function(t){let o={url:e.node.url,folder:e.parentId,nfolder:t[0].title,index:e.index,type:e.node.type,id:e.node.id,title:e.node.title};loglines=logit("Info: Sending remove request to server: <a href='"+e.node.url+"'>"+e.node.url+"</a>"),sendRequest(bookmarkDel,o)})}function sendMark(e){"type"in e||"url"in e?!("type"in e)&&"url"in e&&(e.type="bookmark"):e.type="folder",chrome.bookmarks.get(e.parentId,async function(t){let o={id:e.id,url:e.url,title:e.title,type:e.type,folder:e.parentId,nfolder:t[0].title,added:e.dateAdded};loglines=logit("Info: Sending add request to server: <a href='"+e.url+"'>"+e.url+"</a>"),sendRequest(bookmarkAdd,o)})}async function doFullSync(){loglines=logit("Info: Sync started.");try{chrome.storage.local.get(null,async function(e){loglines=logit("Info: Sending Sync request to server"),sendRequest(bookmarkExport,"json")})}catch(e){loglines=logit("doFullSync: "+e)}finally{chrome.storage.local.set({last_s:1})}}async function importFull(e){function t(e){e.forEach(function(e){a.push(e),e.children&&t(e.children)})}async function o(t,o){let n=0,r=(await searchBookmarkAsync({title:t.bmTitle}))[0];if(void 0===r)n=1;else{let o=e.filter(e=>e.bmID===t.bmParentID)[0].bmTitle,a=(await getBookmarkAsync(r.parentId))[0].title;n=o!==a?2:3}return n}async function n(t){let o="",n="";if(t.bmParentID.endsWith("_____")||1===t.bmParentID.length)n=t.bmParentID;else{let r=t.bmParentID;o=null!=e.filter(e=>e.bmID==r)[0]?e.filter(e=>e.bmID==r)[0].bmTitle:"";let a=await searchBookmarkAsync({title:o});if(!(a.length>0))return!1;n=a[0].id}let r={};mozilla?(r.index=parseInt(t.bmIndex),r.parentId=n,r.title=t.bmTitle,r.url=t.bmURL,r.type=t.bmType):(r.parentId=n,r.title=t.bmTitle,r.url=t.bmURL);let a=await createBookmarkAsync(r),s=a;if(s&&void 0===typeof s.url){let o=t.bmID,n=s.id;e.forEach(async function(t,r){e[r].bmParentID===o&&(e[r].bmParentID=n),e[r].bmID===o&&(e[r].bmID=n)})}}async function r(t){let o=(await searchBookmarkAsync({title:t.bmTitle}))[0],n="",r="";if(t.bmParentID.endsWith("_____")||1===t.bmParentID.length)r=t.bmParentID;else{let o=t.bmParentID;n=e.filter(e=>e.bmID==o)[0].bmTitle;let a=await searchBookmarkAsync({title:n});if(0==a.length)return!1;r=(await searchBookmarkAsync({title:n}))[0].id}let a=new Object;a.parentId=r,"bmIndex"in t&&(a.index=parseInt(t.bmIndex));await moveBookmarkAsync(o.id,a)}loglines=logit("Info: Starting import");const a=[],s=new Array,i=new Array;t(oMarks),a.forEach(function(t){const o=e.some(e=>e.bmTitle===t.title);o||s.push(t)}),bookmarkSync(!1);for(let t=0;t<e.length;t++){let a=0;switch(remoteMark=e[t],a=!0===mozilla&&!remoteMark.bmID.endsWith("_____")||!1===mozilla&&remoteMark.bmID.length>1?await o(remoteMark,t):0,a){case 0:loglines=logit('Debug: Ignore bookmark "'+remoteMark.bmID+'"');break;case 1:loglines=logit('Debug: Create bookmark "'+remoteMark.bmID+'"'),await n(remoteMark);break;case 2:loglines=logit('Debug: Move bookmark "'+remoteMark.bmID+'"'),await r(remoteMark);break;case 3:loglines=logit('Debug: Existing Bookmark "'+remoteMark.bmID+'"'),await r(remoteMark);break;default:loglines=logit('Debug: Unknown action for bookmark "'+remoteMark.bmID+'"')}}let c=0==lastseen?Date.now():lastseen;s.forEach(e=>{e.id.endsWith("_____")||e.id.length<2||(e.dateAdded>=c?i.push(e):(chrome.bookmarks.onRemoved.removeListener(onRemovedCheck),chrome.bookmarks.remove(e.id,function(e){})))}),bookmarkSync(!0),i.length>0&&exportPHPMarks(i)}function c2cm(e){return e.forEach(e=>{"root________"==e.bmID&&(e.bmID="0"),"root________"==e.bmParentID&&(e.bmParentID="0"),"toolbar_____"==e.bmID&&(e.bmID="1"),"toolbar_____"==e.bmParentID&&(e.bmParentID="1"),"unfiled_____"==e.bmID&&(e.bmID="2"),"unfiled_____"==e.bmParentID&&(e.bmParentID="2"),"mobile______"==e.bmID&&(e.bmID="3"),"mobile______"==e.bmParentID&&(e.bmParentID="3"),"menu________"==e.bmID&&(e.bmID="2"),"menu________"==e.bmParentID&&(e.bmParentID="2")}),e}function getBookmarkAsync(e){return new Promise(function(t,o){chrome.bookmarks.get(e,t)})}function searchBookmarkAsync(e){return new Promise(function(t,o){chrome.bookmarks.search(e,t)})}function createBookmarkAsync(e){return new Promise(function(t,o){chrome.bookmarks.create(e,t)})}function moveBookmarkAsync(e,t){return new Promise(function(o,n){chrome.bookmarks.move(e,t,o)})}function importMarks(e,t=0){let o=e[t].bmID,n=e[t].bmParentID,r=parseInt(e[t].bmIndex,10),a=e[t].bmTitle,s=e[t].bmType,i=e[t].bmURL;if(!0===mozilla){var c=void 0!==n&&"__"==n.substr(n.length-2)?n:dictOldIDsToNewIDs[n];if("root________"==n)return importMarks(e,++t),!1}else{c=void 0!==n&&n.length<2?n:dictOldIDsToNewIDs[n];if("0"==n)return importMarks(e,++t),!1}bookmarkSync(!1),!0===mozilla?chrome.bookmarks.create("folder"==s?{index:r,parentId:c,title:a,type:s}:{index:r,parentId:c,title:a,type:s,url:i},function(n){let r="__"==o.substr(o.length-2)?o:n.id;dictOldIDsToNewIDs[o]=r,++count,void 0===e[t+1]?(message=count+chrome.i18n.getMessage("successImportBookmarks"),notify("info",message),loglines=logit("Info: "+message+" Re-adding the listeners now"),bookmarkSync(!1)):importMarks(e,++t)}):o.length>1&&chrome.bookmarks.create("folder"==s?{index:r,parentId:c,title:a}:{parentId:c,title:a,url:i},function(n){let r=e.length,a=t+1;if(a<r){let t=o.length<2?o:n.id;dictOldIDsToNewIDs[o]=t,importMarks(e,a)}else message=e.length+chrome.i18n.getMessage("successImportBookmarks"),notify("info",message),loglines=logit("Info: "+message+" Re-adding the listeners now"),bookmarkSync(!0)})}function addAllMarks(e,t=1){bookmarkSync(!1);let o=e[t].id,n=e[t].parentId,r=e[t].index,a=e[t].title,s=e[t].type,i=e[t].url,c=e[t].dateAdded,l=void 0!==n&&"__"==n.substr(n.length-2)?n:dictOldIDsToNewIDs[n];if("root________"==n||c<last_s)return addAllMarks(e,++t),!1;chrome.bookmarks.create("separator"==s?{index:r,parentId:l,type:s}:"folder"==s?{index:r,parentId:l,title:a,type:s}:{index:r,parentId:l,title:a,type:s,url:i},function(n){let r="__"==o.substr(o.length-2)?o:n.id;if(dictOldIDsToNewIDs[o]=r,++count,void 0!==e[t+1])addAllMarks(e,++t);else{message=count+chrome.i18n.getMessage("successImportBookmarks"),notify("info",message),loglines=logit("Info: "+message),bookmarkSync(!0);let e=Date.now(),t=new Date(e),o={weekday:"short",hour:"2-digit",minute:"2-digit"};chrome.storage.local.set({last_s:e}),chrome.action.setTitle({title:chrome.i18n.getMessage("extensionName")+": "+t.toLocaleDateString(void 0,o)})}})}const mozilla="undefined"!=typeof browser;var dictOldIDsToNewIDs={"-1":"-1"},loglines="",debug=!1,oMarks=[],pTabs=[],lastseen=null;if(chrome.runtime.onStartup.addListener(async()=>{init()}),!0===mozilla)init();else{setInterval(()=>{chrome.runtime.getPlatformInfo,self.serviceWorker.postMessage("keep")},2e4)}chrome.runtime.onMessage.addListener(function(e,t,o){if(t.id===chrome.runtime.id)switch(e.action){case"clientInfo":sendRequest(clientInfo,e.data,e.tab);break;case"clientRename":sendRequest(clientRename,e.data);break;case"clientSendOptions":sendRequest(clientSendOptions,e.data);break;case"clientGetOptions":sendRequest(clientGetOptions);break;case"clientRemove":sendRequest(clientRemove,e.data);break;case"removeAllMarks":removeAllMarks();break;case"bookmarkExport":sendRequest(bookmarkExport,e.data,e.tab);break;case"exportPHPMarks":exportPHPMarks();break;case"loglines":console.log(e.data);break;case"getLoglines":0==loglines.length&&(loglines=logit("Info: No Log entry available")),chrome.runtime.sendMessage({task:"rLoglines",text:loglines});break;case"emptyLoglines":loglines="",chrome.runtime.sendMessage({task:"rLoglines",text:loglines});break;case"changeIcon":changeIcon(e.data);break;case"bookmarkTab":bookmarkTab();break;case"tabSync":tabSync(e.data);break;default:return!1}}),chrome.permissions.getAll(function(e){chrome.storage.local.get(null,function(e){chrome.bookmarks&&bookmarkSync(e.sync),tabSync(e.tabs)}),e.permissions.includes("contextMenus")&&chrome.contextMenus.onClicked.addListener(function(e){if((e.menuItemId.includes("page_")||e.menuItemId.includes("tab_"))&&chrome.tabs.query({active:!0,currentWindow:!0},function(t){let o={target:{id:e.menuItemId.substring(5),url:t[0].url}};sendTab(o)}),e.menuItemId.includes("link_")){let t={target:{id:e.menuItemId.substring(5),url:e.linkUrl}};sendTab(t)}})}),chrome.runtime.onInstalled.addListener(onInstalled),chrome.notifications.onClicked.addListener(notificationSettings),chrome.tabs.onActivated.addListener(onTabActivated),void 0!==chrome.commands&&chrome.commands.onCommand.addListener(e=>{bookmarkTab()});