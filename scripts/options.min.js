function showMsg(e,t){let n=document.getElementById("wmessage");n.textContent=e,n.style.cssText="info"==t?"border-color: green; background-color: #98FB98;":"border-color: red; background-color: lightsalmon;",n.className="show",setTimeout(function(){n.className=n.className.replace("show","hide")},5e3)}function checkForm(){let e=document.getElementById("wdurl");e.classList.contains("valid")&&(document.getElementById("blogin").disabled=!1),chrome.permissions.getAll(function(t){t.permissions.includes("bookmarks")?""!=e.value?(document.getElementById("mdownload").disabled=!1,document.getElementById("mupload").disabled=!1):(document.getElementById("mdownload").disabled=!0,document.getElementById("mupload").disabled=!0):(showMsg(chrome.i18n.getMessage("optionsBAPIHint"),"info"),chrome.storage.local.set({sync:!1}),document.getElementById("mdownload").disabled=!0,document.getElementById("mupload").disabled=!0,document.getElementById("s_auto").checked=!1,document.getElementById("s_auto").disabled=!0)})}function checkLoginForm(){""!=document.getElementById("nuser").value&&""!=document.getElementById("npassword").value?document.getElementById("lgin").disabled=!1:document.getElementById("lgin").disabled=!0}function gToken(e){e.preventDefault(),document.getElementById("blogin").classList.add("loading"),document.getElementById("crdialog").style.display="none";const t={action:"clientCheck",client:document.getElementById("s_uuid").value,sync:document.getElementById("s_auto").checked},n=document.getElementById("wdurl").value,o=btoa(document.getElementById("nuser").value+":"+document.getElementById("npassword").value),s=new Headers;s.append("Content-Type","application/json;charset=UTF-8"),s.append("Authorization","Basic "+o);fetch(n+"?api=v1",{method:"POST",body:JSON.stringify(t),headers:s,redirect:"follow",referrerPolicy:"no-referrer"}).then(e=>e.json()).then(e=>{document.getElementById("blogin").classList.remove("loading");let t={sync:document.getElementById("s_auto").checked,name:document.getElementById("cname").value,uuid:document.getElementById("s_uuid").value,tabs:document.getElementById("s_tabs").checked,instance:document.getElementById("wdurl").value};t.token=e.token,chrome.storage.local.set(t),document.getElementById("blogin").removeAttribute("style"),chrome.action.setBadgeText({text:"i"}),chrome.action.setBadgeBackgroundColor({color:"chartreuse"}),chrome.action.setTitle({title:chrome.i18n.getMessage("extensionName")}),setTimeout(function(){chrome.action.setBadgeText({text:""})},5e3),document.getElementById("cname").defaultValue=e.cname,-1!==e.message.indexOf("updated")||-1!==e.message.indexOf("registered")?(wmessage.textContent=e.message,wmessage.style.cssText="border-color: green; background-color: #98FB98;",requestClientOptions(e.cOptions)):(wmessage.textContent="Warning: "+e.message,wmessage.style.cssText="border-color: red; background-color: lightsalmon;",chrome.runtime.sendMessage({action:"loglines",data:"Syncmarks Warning: "+e.message}))}).catch(e=>{switch(wmessage.style.cssText="border-color: red; background-color: lightsalmon;",chrome.runtime.sendMessage({action:"loglines",data:e}),response.status){case 404:wmessage.textContent=chrome.i18n.getMessage("optionsErrorURL")+e;break;case 401:wmessage.textContent=chrome.i18n.getMessage("optionsErrorUser")+e;break;default:wmessage.textContent=chrome.i18n.getMessage("optionsErrorLogin")+response.status+e}chrome.runtime.sendMessage({action:"loglines",data:"Syncmarks Error: "+wmessage.textContent})});wmessage.className="show",setTimeout(function(){wmessage.className=wmessage.className.replace("show","hide")},5e3)}function saveOptions(e){void 0!==e&&e.preventDefault();let t=chrome.i18n.getMessage("optionsSuccessSave"),n="info";("undefined"==typeof last_sync||last_sync.toString().length<=0)&&(t=chrome.i18n.getMessage("optionsNotUsed"),n="error");const o={sync:document.getElementById("s_auto").checked,name:document.getElementById("cname").value,uuid:document.getElementById("s_uuid").value,tabs:document.getElementById("s_tabs").checked,instance:document.getElementById("wdurl").value};chrome.storage.local.set(o),chrome.runtime.sendMessage({action:"clientSendOptions",data:o}),showMsg(t,n),chrome.runtime.sendMessage({action:"tabSync",data:o.tabs}),chrome.runtime.sendMessage({action:"bookmarkSync",data:o.sync})}function rName(){chrome.runtime.sendMessage({action:"clientRename",data:this.value})}function gName(){chrome.tabs.query({active:!0,currentWindow:!0},e=>{chrome.runtime.sendMessage({action:"clientInfo",tab:e[0].id})})}function uuidv4(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}function restoreOptions(){chrome.tabs.query({active:!0,currentWindow:!0},e=>{chrome.runtime.sendMessage({action:"clientInfo",tab:e[0].id})});let e=document.getElementById("s_uuid"),t=document.getElementById("cname"),n=document.getElementById("wdurl"),o=document.getElementById("s_auto"),s=document.getElementById("s_tabs"),d=document.getElementById("blogin");chrome.storage.local.get(null,function(a){null==a.instance&&showMsg(chrome.i18n.getMessage("infoEmptyConfig"),"info"),n.defaultValue=a.instance||"",checkURL(),uuid=void 0===a.uuid?uuidv4():a.uuid,t.placeholder=uuid,e.defaultValue=uuid,o.defaultChecked=a.sync,gName(),void 0===a.token&&(d.disabled=!1,d.style.backgroundColor="red"),s.defaultChecked=null!=a.tabs&&a.tabs,last_sync=a.last_sync||0,last_sync.toString().length>0&&o.removeAttribute("disabled"),checkForm(),chrome.permissions.getAll(function(e){!1===e.permissions.includes("bookmarks")&&(o.disabled=!0,o.checked=!1),!1===e.permissions.includes("tabs")&&(s.disabled=!0,s.checked=!1)}),chrome.commands&&chrome.commands.getAll(e=>{for(let{name:t,shortcut:n}of e);})})}function manualImport(e){e.preventDefault(),"iyes"===this.id&&chrome.runtime.sendMessage({action:"removeAllMarks"});try{chrome.tabs.query({active:!0,currentWindow:!0},e=>{chrome.runtime.sendMessage({action:"bookmarkExport",data:"json",tab:e[0].id})})}catch(e){chrome.runtime.sendMessage({action:"loglines",data:e})}finally{document.getElementById("impdialog").style.display="none",chrome.storage.local.set({last_s:1})}}function manualExport(e){e.preventDefault();try{chrome.runtime.sendMessage({action:"exportPHPMarks"})}catch(e){chrome.runtime.sendMessage({action:"loglines",data:e})}finally{document.getElementById("expdialog").style.display="none",chrome.storage.local.set({last_s:1})}}function localizeHtmlPage(){for(var e=document.getElementsByTagName("span"),t=0;t<e.length;t++){var n=e[t],o=n.innerHTML.toString(),s=o.replace(/__MSG_(\w+)__/g,function(e,t){return t?chrome.i18n.getMessage(t):""});s!=o&&(n.innerText=s)}document.getElementById("oauto").title=chrome.i18n.getMessage("ManAuto"),document.getElementById("nuser").placeholder=chrome.i18n.getMessage("optionsUsername"),document.getElementById("npassword").placeholder=chrome.i18n.getMessage("optionsPassword"),document.getElementById("title").innerText=chrome.i18n.getMessage("extensionName")+" - "+chrome.i18n.getMessage("optionsBTNSettings"),document.getElementById("obmc").title=chrome.i18n.getMessage("optionsTabsHint")}function filterLog(){chrome.runtime.sendMessage({action:"getLoglines"})}function rLoglines(e){let t=document.getElementById("logarea"),n=e.split("\n"),o=document.getElementById("logdebug").checked,s=new Array;n.forEach(function(e,t){o?s.push(e):!o&&e.indexOf("Debug:")<0&&s.push(e)});let d=s.join("\n"),a=(new DOMParser).parseFromString(d,"text/html").body;var c=t.querySelector("body");c?c.replaceWith(a):t.appendChild(a)}function openTab(e){let t=document.getElementsByClassName("otabs"),n=document.getElementById("logarea");n.childNodes.length>2&&n.removeChild(n.childNodes[2]),"logfile"==e.target.dataset.val&&chrome.runtime.sendMessage({action:"getLoglines"});for(var o=0;o<t.length;o++)t[o].style.display="none";document.getElementById(e.target.attributes["data-val"].value).style.display="block",document.querySelectorAll(".tab-button").forEach(function(e){e.classList.remove("abutton")}),document.querySelector('button[data-val="'+e.target.attributes["data-val"].value+'"]').classList.add("abutton")}function saveLog(){var e=document.querySelector("#logarea body").innerText,t=document.createElement("a");t.href="data:text/plain;charset=utf-8,"+encodeURIComponent(e),t.download="SyncMarks.log",t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}function clearLog(){chrome.runtime.sendMessage({action:"emptyLoglines"})}function requestHostPermission(){const e=document.getElementById("wdurl");let t=new URL(e.value).origin+"/*";chrome.permissions.request({origins:[t]},e=>{const n=e?"Syncmarks: Access to "+t+" granted":"Syncmarks Warning: Access to "+t+" denied";chrome.runtime.sendMessage({action:"loglines",data:n}),checkURL()})}function requestClientOptions(e,t=!1){chrome.storage.local.get(null,function(n){void 0!==e&&e.length>0&&(select=document.getElementById("cimport"),select.length=0,e.forEach(e=>{var o=document.createElement("option");o.value=e.cOptions,o.innerText=e.cname,select.appendChild(o),n.uuid==e.cid&&(t=!0)}),t||(document.getElementById("coptionsdialog").style.display="block"))})}function serverImport(){const e=document.getElementById("s_uuid").value,t=document.getElementById("wdurl").value,n=document.getElementById("cimport"),o=JSON.parse(n.value);let s=n.options[n.selectedIndex].text;const d=o.uuid,a=btoa(document.getElementById("nuser").value+":"+document.getElementById("npassword").value);document.getElementById("cname").value=s!=o.name?s:o.name,document.getElementById("s_tabs").checked=o.tabs,document.getElementById("s_auto").checked=o.sync,document.getElementById("coptionsdialog").style.display="none",saveOptions(),setTimeout(()=>{if(confirm(chrome.i18n.getMessage("infoRestoreID"))){const n={action:"clientRemove",client:e,data:{new:e,old:d}};fetch(t+"?api=v1",{method:"POST",cache:"no-cache",headers:{"Content-type":"application/json;charset=UTF-8",Authorization:"Basic "+a},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(n)}).then(e=>{let t=e.headers.get("X-Request-Info");return null!=t&&chrome.storage.local.set({token:t}),e.json()}).then(e=>{chrome.runtime.sendMessage({action:"loglines",data:"Info: Old client removed"})}).catch(e=>{chrome.runtime.sendMessage({action:"loglines",data:"Error: "+e})})}},500)}function checkURL(){let e=document.getElementById("wdurl");var t=new XMLHttpRequest;t.open("GET",e.value,!0),t.onreadystatechange=function(){4===t.readyState&&204===t.status?(e.classList.add("valid"),e.nextElementSibling.classList.add("valid"),e.classList.remove("invalid"),e.nextElementSibling.classList.remove("invalid"),document.getElementById("blogin").disabled=!1):(e.classList.add("invalid"),e.nextElementSibling.classList.add("invalid"),e.classList.remove("valid"),e.nextElementSibling.classList.remove("valid"),document.getElementById("blogin").disabled=!0)},t.setRequestHeader("X-Action","verify"),t.send(null)}chrome.runtime.onMessage.addListener(function(e,t,n){if(t.id===chrome.runtime.id)switch(e.task){case"clientInfo":document.getElementById("cname").title=e.cname?document.getElementById("s_uuid").value+" ("+e.ctype+")":document.getElementById("s_uuid").value,null!==e&&(document.getElementById("cname").defaultValue=e.cname==document.getElementById("s_uuid").value?"":e.cname);let t=document.getElementById("lgini"),n=document.getElementById("ipinfo");if(t.style.display="block",null!=e.cinfo){n.innerText=e.cinfo.ip;let t=document.createElement("span");t.className="iiinfo",t.id="iiinfo";let o=new Date(1e3*e.cinfo.tm).toLocaleString();t.innerText=o+"\n"+e.cinfo.de+" | "+e.cinfo.co+" | "+e.cinfo.ct+" | "+e.cinfo.re+"\n"+e.cinfo.ua,document.getElementById("iiinfo")&&document.getElementById("iiinfo").remove(),n.after(t)}break;case"bookmarkImport":showMsg(chrome.i18n.getMessage(e.text),"error"===e.type?"error":"info");break;case"bookmarkExport":case"clientRename":showMsg(e.text,"error"===e.type?"error":"info");break;case"rLoglines":rLoglines(e.text);break;case"clientOptions":requestClientOptions(e.cOptions,!1)}}),document.addEventListener("DOMContentLoaded",restoreOptions),window.addEventListener("load",function(){var e=new XMLHttpRequest;e.open("GET","../CHANGELOG.md",!0),e.responseType="text",e.onreadystatechange=function(){4===e.readyState&&(200!==e.status&&0!=e.status||(document.getElementById("changelog").innerText=e.responseText))},e.send(null);var t=document.getElementById("impdialog"),n=document.getElementById("expdialog"),o=document.getElementById("expimpdialog"),s=document.getElementById("coptionsdialog");localizeHtmlPage(),document.getElementById("version").textContent=chrome.runtime.getManifest().version,document.getElementById("econf").addEventListener("click",function(){o.style.display="block"}),document.getElementById("cclose").addEventListener("click",function(){o.style.display="none"}),document.getElementById("cimp").addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),o.style.display="none",chrome.runtime.sendMessage({action:"clientGetOptions"})}),document.getElementById("logdebug").addEventListener("change",filterLog),document.getElementById("iyes").addEventListener("click",manualImport),document.getElementById("eyes").addEventListener("click",manualExport),document.getElementById("ino").addEventListener("click",manualImport),document.getElementById("coimport").addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),serverImport()}),document.getElementById("cochancel").addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),s.style.display="none"}),document.getElementById("lchancel").addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),document.getElementById("crdialog").style.display="none"}),document.getElementById("imchancel").addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),document.getElementById("expimpdialog").style.display="none"}),document.getElementById("eno").addEventListener("click",function(){n.style.display="none"}),document.getElementById("iclose").addEventListener("click",function(){t.style.display="none"}),document.getElementById("eclose").addEventListener("click",function(){n.style.display="none"}),document.getElementById("oclose").addEventListener("click",function(){s.style.display="none"}),document.getElementById("crclose").addEventListener("click",function(){document.getElementById("crdialog").style.display="none"}),document.getElementById("mdownload").addEventListener("click",function(){t.style.display="block"}),document.getElementById("mupload").addEventListener("click",function(){n.style.display="block"}),document.getElementById("wdurl").addEventListener("blur",function(){requestHostPermission(),checkURL()}),document.getElementById("wdurl").addEventListener("change",checkForm),document.getElementById("blogin").addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),requestHostPermission(),document.getElementById("nuser").defaultValue="",document.getElementById("npassword").defaultValue="",document.getElementById("crdialog").style.display="block",document.getElementById("nuser").focus()}),document.getElementById("nuser").addEventListener("input",checkLoginForm),document.getElementById("npassword").addEventListener("input",checkLoginForm),document.getElementById("lgin").addEventListener("click",gToken),document.getElementById("s_tabs").addEventListener("change",saveOptions),document.getElementById("s_auto").addEventListener("change",saveOptions),document.getElementById("cname").addEventListener("change",rName),document.querySelectorAll(".tab-button").forEach(function(e){e.addEventListener("click",openTab)}),document.getElementById("logsave").addEventListener("click",saveLog),document.getElementById("logclear").addEventListener("click",clearLog),document.querySelector("h1").addEventListener("click",function(){window.open(document.getElementById("wdurl").value)}),window.onclick=function(e){e.target==t&&(t.style.display="none"),e.target==n&&(n.style.display="none")}});